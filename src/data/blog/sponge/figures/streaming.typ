#import "@preview/fletcher:0.5.2" as fletcher: *

#diagram(
  spacing: (10mm, 0mm),
  cell-size: (0mm, 15mm),
  node((0,0), $M$),
  edge("-|>"),
  node((0,1), `pad()`),
  // node((0, 2), enclose: ((0,2), (0,5)), name: <s>),
  node((0,2), $r$, shape: rect, stroke: 1pt, height: 25mm),
  node((0,3), $c$, shape: rect, stroke: 1pt, height: 15mm),
  node((-.45, 2.38), $s space space cases(,,,,,,,,)$),
  node((1,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((0, 3), (.5,3), (.5, 2.5), (1, 2.5), "-|>"),
  edge((0, 2), (1, 2), "-|>", label: $xor$, label-side: center),
  edge((0,1), (0.5, 1), (.5, 1.9), "-|>", label: $m_0$, label-pos: 0.7, label-side:center),
  node((3.5,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((1, 2.5), (3.5,2.5), "-|>"),
  edge((1, 2), (3.5,2), "-|>", label: $xor$, label-side: center, label-pos: 0.7),
  edge((0,1), (2.65, 1), (2.65, 1.9), "-|>", label: $m_1$, label-pos: 0.7, label-side: center),
  edge((1.75, 2), (1.75, .75), (5.5, .75), (5.5, 0), "-|>", label: $h_0$, label-side:center, label-pos: 0.175),
  node((5.5,0), $H$),
  node((5.5,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((3.5, 2.5), (5.5,2.5), "-|>"),
  edge((3.5, 2), (5.5,2), "-|>", label: $xor$, label-side: center, label-pos: 0.7),
  edge((0,1), (4.835, 1), (4.835, 1.9), "-|>", label: $m_2$, label-pos: 0.7, label-side: center),
  edge((4.2, 2), (4.2, .75), label: $h_1$, label-side: center, label-pos:0.5),
  node((6, 2.2), $dots$),
  edge((0,1), (4.835, 1), (4.835, 1.1), "-", label: `pad()`, label-pos: 0.36, label-side: center),
  edge((0,1), (2.65, 1), (2.65, 1.1), "-", label: `pad()`, label-pos: 0.2, label-side: center),
)
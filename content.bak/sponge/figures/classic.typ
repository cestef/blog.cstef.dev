#import "@preview/fletcher:0.5.2" as fletcher: *

#diagram(
  spacing: (10mm, 0mm),
  cell-size: (0mm, 15mm),
  node((0,0), $M$),
  edge("-|>"),
  node((0,1), `pad()`),
  // node((0, 2), enclose: ((0,2), (0,5)), name: <s>),
  node((0,2), $r$, shape: rect, stroke: 1pt, height: 25mm),
  node((0,3), $c$, shape: rect, stroke: 1pt, height: 15mm),
  node((-.45, 2.38), $s space space cases(,,,,,,,,)$),
  node((1,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((0, 3), (.5,3), (.5, 2.5), (1, 2.5), "-|>"),
  edge((0, 2), (1, 2), "-|>", label: $xor$, label-side: center),
  edge((0,1), (0.5, 1), (.5, 1.9), "-|>", label: $m_0$, label-pos: 0.7, label-side:center),
  node((2.5,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((1, 2.5), (2.5,2.5), "-|>"),
  edge((1, 2), (2.5,2), "-|>", label: $xor$, label-side: center),
  edge((0,1), (1.72, 1), (1.72, 1.9), "-|>", label: $m_1$, label-pos: 0.7, label-side: center),
  edge((2.5, 2), (4.5,2), "--|>"),
  edge((2.5, 2.5), (4.5,2.5), "--|>"),
  node((4.5,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((4.5, 2.5), (5.75,2.5), "-|>"),
  edge((4.5, 2), (5.75,2), "-|>"),
  node((5.75,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((3.5, 3.75), (3.5,1), "--", stroke: 1.125pt),
  edge((5.125, 2), (5.125, 1), (7.865, 1), (7.865, 0), "-|>", label: $h_0$, label-side: center, label-pos:0.22),
  edge((6.3, 2), (6.3, 1), (7.865, 1), (7.865, 0), "-|>", label: $h_1$, label-side: center, label-pos: 0.23),
  node((7.865,0), $H$),
  node((6.865,2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((6, 2),(6.865, 2), "-|>"),
  edge((6, 2.5),(6.865, 2.5), "-|>"),
  node((7.865, 2.25), $f$, shape: rect, corner-radius: .75em, stroke: 1pt, height: 30mm),
  edge((7, 2), (7.865,2), "--|>"),
  edge((7, 2.5), (7.865,2.5), "--|>"),
  edge((7.36, 2), (7.36, 1), (7.865, 1), (7.865, 0), "-|>", label: $h_ell$, label-side: center, label-pos: 0.23),
)